{% load thought_tags %}
{% load payment_tags %}

<p>{{ locked_thought_count }} thoughts are  waiting to be unlocked. </p>
<p>{{ unlocked_thought_count }} thoughts have been unlocked. </p>
<p>{{ total_dollars_donated|currency }} donated. </p>


<p>Preview of next thought: </p>
<p>{{ next_locked_thought.text|truncatechars:30 }} </p>

<p>Enter a thought: </p>

<form method=post action="{% url 'penny_for_your_thoughts.views.index' %}" >
  {% csrf_token %}
  {{ thought_form.text }}
  {{ thought_form.user.as_hidden }}
  <input type="submit" value="submit">
</form>

<h3>Unlocked Thoughts</h3>
{% show_unlocked_thoughts %}

<body>
  <form action="{% url 'penny_for_your_thoughts.views.charge' %}" method="post">
  {% csrf_token %}
    <article>
    <label>
      <span>Donate to unlock thoughts</span>
    </label>
    </article>

    <script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
      data-key="{{ key }}"
      data-description="Donation"
      data-amount="500"></script>
  </form>

  <form action="{% url 'penny_for_your_thoughts.views.charge' %}" method="post" id="payment-form">
    {% csrf_token %}

    <span class="payment-errors"></span>

    <div class="form-row">
      <label>
        <span>Card Number</span>
        <input type="text" size="20" data-stripe="number"/>
      </label>
    </div>

    <div class="form-row">
      <label>
        <span>CVC</span>
        <input type="text" size="4" data-stripe="cvc"/>
      </label>
    </div>

    <div class="form-row">
      <label>
        <span>Expiration (MM/YYYY)</span>
        <input type="text" size="2" data-stripe="exp-month"/>
      </label>
      <span> / </span>
      <input type="text" size="4" data-stripe="exp-year"/>
    </div>

    <button type="submit">Submit Payment</button>
  </form>

  <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <script type="text/javascript">
    Stripe.setPublishableKey('{{ key }}');

    var stripeResponseHandler = function(status, response) {
      var $form = $('#payment-form');

      if (response.error) {
        $form.find('.payment-errors').text(response.error.message);
        $form.find('button').prop('disabled', false);
      } else {
        var token = response.id;
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        $form.append($('<input type="hidden" name="stripeEmail" />').val(token));
        $form.get(0).submit();
      }
    };

  jQuery(function($) {
    $('#payment-form').submit(function(e) {
      alert("hello")
      var $form = $(this);
      $form.find('button').prop('disabled', true);
      Stripe.card.createToken($form, stripeResponseHandler);
      return false;
      });
    });
  </script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</body>
